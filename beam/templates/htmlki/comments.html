<div class="comment-section">
  <h3>Комментарии</h3>

  <!-- Форма для нового комментария -->
  <div class="add-comment-form">
    <textarea id="comment-text" placeholder="Введите ваш комментарий..."></textarea>
    <button onclick="submitComment()">Добавить комментарий</button>
  </div>

  <!-- Список существующих комментариев -->
  <div id="comments-list">
    <!-- Комментарии будут загружаться здесь -->
  </div>
</div>

<script>
  function submitComment() {
    const text = document.getElementById('comment-text').value;
    const postId = 1; // Замените на реальный ID поста

    fetch('/api/comments/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + localStorage.getItem('token') // Для JWT
      },
      body: JSON.stringify({
        post: postId,
        text: text
      })
    })
    .then(response => response.json())
    .then(data => {
      alert('Комментарий добавлен!');
      loadComments(); // Перезагружаем список
    })
    .catch(error => {
      console.error('Ошибка:', error);
      alert('Ошибка при добавлении комментария');
    });
  }

  function loadComments() {
    fetch('/api/comments/?post_id=1') // Замените на нужный ID поста
      .then(response => response.json())
      .then(comments => {
        const list = document.getElementById('comments-list');
        list.innerHTML = '';

        comments.forEach(comment => {
          list.innerHTML += `
            <div class="comment">
              <strong>${comment.author.username}:</strong>
              <p>${comment.text}</p>
              <small>${new Date(comment.created_at).toLocaleString()}</small>
            </div>
          `;
        });
      });
  }

  // Загружаем комментарии при открытии страницы
  document.addEventListener('DOMContentLoaded', loadComments);
</script>
document.getElementById('comment-form').addEventListener('submit', async (e) => {
    e.preventDefault();

    const formData = {
        post: document.getElementById('post-id').value,
        text: document.getElementById('comment-text').value
    };

    try {
        const response = await fetch('/api/comments/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken'),
                'Authorization': `Bearer ${localStorage.getItem('token')}`
            },
            body: JSON.stringify(formData)
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.error || 'Ошибка сервера');
        }

        const result = await response.json();
        alert('Комментарий успешно добавлен!');
        location.reload(); // Обновляем страницу

    } catch (error) {
        console.error('Ошибка:', error);
        alert(`Ошибка: ${error.message}`);
    }
});

// Функция для получения CSRF-токена
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
